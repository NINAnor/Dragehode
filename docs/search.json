[
  {
    "objectID": "direction_plots.html#hadeland",
    "href": "direction_plots.html#hadeland",
    "title": "5  Figurer som viser retning i endring",
    "section": "5.1 Hadeland",
    "text": "5.1 Hadeland\n\n\n5.1.1 Lokaliteter"
  },
  {
    "objectID": "direction_plots.html#oslo",
    "href": "direction_plots.html#oslo",
    "title": "5  Figurer som viser retning i endring",
    "section": "5.2 Oslo",
    "text": "5.2 Oslo\n\n\n5.2.1 Lokaliteter"
  },
  {
    "objectID": "direction_plots.html#ringerike",
    "href": "direction_plots.html#ringerike",
    "title": "5  Figurer som viser retning i endring",
    "section": "5.3 Ringerike",
    "text": "5.3 Ringerike\n\n\n5.3.1 Lokaliteter"
  },
  {
    "objectID": "localEst.html#hadeland",
    "href": "localEst.html#hadeland",
    "title": "2  Lokale estimater av populasjonsstørrelse",
    "section": "2.1 Hadeland",
    "text": "2.1 Hadeland"
  },
  {
    "objectID": "localEst.html#oslo",
    "href": "localEst.html#oslo",
    "title": "2  Lokale estimater av populasjonsstørrelse",
    "section": "2.2 Oslo",
    "text": "2.2 Oslo"
  },
  {
    "objectID": "localEst.html#ringerike",
    "href": "localEst.html#ringerike",
    "title": "2  Lokale estimater av populasjonsstørrelse",
    "section": "2.3 Ringerike",
    "text": "2.3 Ringerike"
  },
  {
    "objectID": "localEst.html#mjøsa",
    "href": "localEst.html#mjøsa",
    "title": "2  Lokale estimater av populasjonsstørrelse",
    "section": "2.4 Mjøsa",
    "text": "2.4 Mjøsa"
  },
  {
    "objectID": "localEst.html#gudbrandsdalen",
    "href": "localEst.html#gudbrandsdalen",
    "title": "2  Lokale estimater av populasjonsstørrelse",
    "section": "2.5 Gudbrandsdalen",
    "text": "2.5 Gudbrandsdalen"
  },
  {
    "objectID": "localEst.html#valdres",
    "href": "localEst.html#valdres",
    "title": "2  Lokale estimater av populasjonsstørrelse",
    "section": "2.6 Valdres",
    "text": "2.6 Valdres"
  },
  {
    "objectID": "transect_est.html#hadeland",
    "href": "transect_est.html#hadeland",
    "title": "6  Transektbaserte estimater av populasjonsstørrelse",
    "section": "6.1 Hadeland",
    "text": "6.1 Hadeland"
  },
  {
    "objectID": "transect_est.html#oslo",
    "href": "transect_est.html#oslo",
    "title": "6  Transektbaserte estimater av populasjonsstørrelse",
    "section": "6.2 Oslo",
    "text": "6.2 Oslo"
  },
  {
    "objectID": "transect_est.html#ringerike",
    "href": "transect_est.html#ringerike",
    "title": "6  Transektbaserte estimater av populasjonsstørrelse",
    "section": "6.3 Ringerike",
    "text": "6.3 Ringerike"
  },
  {
    "objectID": "codeBook.html",
    "href": "codeBook.html",
    "title": "7  Code to recreate the analysis",
    "section": "",
    "text": "For å se funksjonene, gå til Chapter 8\n\n# Population estimation script ----\n## Load libraries ----\nlibrary(boot)\nlibrary(rio)\nlibrary(Dragehode)\nlibrary(tidyverse)\n#Sys.setlocale(locale = 'Norwegian Bokm�l_Norway') \n# Uncomment this line if you locale is not Norway\nsource('R/funksjoner.R', encoding = \"UTF-8\")\n\n## Dataimport ----\n\n### save the data with the addition of this years data as \"Dragehode_overvaking_DATA.xlsx\" in the \"/data\" folder\n### To reduce the burden (data storage on GitHub is not recommended) on the GitHub repo the data will be stored as RDS files\n\nlokalitetsdata &lt;- import(\"data/Dragehode_overvaking_DATA.xlsx\",sheet=\"Lokalitetsdata\",na=c(\"NA\"))\ntransektdata &lt;- import(\"data/Dragehode_overvaking_DATA.xlsx\",sheet=\"Transektdata\",na=c(\"NA\",\" \"))\nrutedata &lt;- import(\"data/Dragehode_overvaking_DATA.xlsx\",sheet=\"Rutedata\",na=c(\"NA\"))\nartsdata &lt;- import(\"data/Dragehode_overvaking_DATA.xlsx\",sheet=\"Artsdata\",na=c(\"NA\"))\nkorreksjonsdata &lt;- import(\"data/siriskuddogind.xlsx\")\n\n### Save the data that has been imported to overwrite last years files ----\n\nsaveRDS(lokalitetsdata, \"data/lokalitetsdata.RDS\")\nsaveRDS(transektdata, \"data/transektdata.RDS\")\nsaveRDS(rutedata, \"data/rutedata.RDS\")\nsaveRDS(artsdata, \"data/artsdata.RDS\")\nsaveRDS(korreksjonsdata, \"data/korreksjonsdata.RDS\")\n\n\n# Datajusteringer ----\n\n### Remove NAs ---- \n\nrutedata &lt;- rutedata[!is.na(rutedata$Lokalitet), ]\nlokalitetsdata &lt;- lokalitetsdata[!apply(lokalitetsdata,1,function(x){all(is.na(x))}),]\ntransektdata &lt;- transektdata[!apply(transektdata,1,function(x){all(is.na(x))}),]\nrutedata &lt;- rutedata[!apply(rutedata,1,function(x){all(is.na(x))}),]\n\n### change format of Lokalitet to factor ----\nlokalitetsdata$Lokalitet &lt;- factor(lokalitetsdata$Lokalitet)\n\n### data to be omitted (single sampling event or change in method in earliest years) ----\nlok.utelates &lt;- c(\"Nedre R�ykenvik\",\"�vre R�ykenvik\")\nlokalitetsdata &lt;- lokalitetsdata[!(lokalitetsdata$Lokalitet%in%lok.utelates),]; lokalitetsdata$Lokalitet &lt;- factor(lokalitetsdata$Lokalitet)\ntransektdata &lt;- transektdata[!(transektdata$Lokalitet%in%lok.utelates),]; transektdata$Lokalitet &lt;- factor(transektdata$Lokalitet)\nrutedata &lt;- rutedata[!(rutedata$Lokalitet%in%lok.utelates),]; rutedata$Lokalitet &lt;- factor(rutedata$Lokalitet)\n\nlokalitetsdata &lt;- lokalitetsdata[!(lokalitetsdata$Lokalitet%in%c(\"Falang\") & lokalitetsdata$�r&lt;2020),]\ntransektdata &lt;- transektdata[!(transektdata$Lokalitet%in%c(\"Falang\") & transektdata$�r&lt;2020),]\nrutedata &lt;- rutedata[!(rutedata$Lokalitet%in%c(\"Falang\") & rutedata$�r&lt;2020),]\n### Create a hovednaturtype by combining the Naturtypes in to a single column ----\nlokalitetsdata$Hovednaturtype &lt;- sapply(strsplit(lokalitetsdata$Naturtype,\"-\"),function(x){x[[1]]})\n\n### Change character data to character formats and create a hovedskj�tsel coloumn ----\nlokalitetsdata$Hovedskj�tsel &lt;- as.character(lokalitetsdata$Krattrydding_bin�r)\nlokalitetsdata$Hovedskj�tsel[lokalitetsdata$Krattrydding_bin�r==\"Ja\"] &lt;- \"Krattrydding\"\nlokalitetsdata$Hovedskj�tsel[lokalitetsdata$Sl�tt_bin�r==\"Ja\"] &lt;- \"Sl�tt\"\nlokalitetsdata$Hovedskj�tsel[lokalitetsdata$Hovedskj�tsel==\"Nei\"] &lt;- \"Ingen/annet\"\nlokalitetsdata$Hovedskj�tsel &lt;- factor(lokalitetsdata$Hovedskj�tsel)\n\n### convert \"ingen\" to NA ----\ntransektdata$`Forekomst dragehode (m)`[transektdata$`Forekomst dragehode (m)`%in%c(\"ingen\",\" \")] &lt;- NA\n\n# Get coverage ----\n\nartsdata$Vedplante&lt;-artsdata$`Vedplante i feltsjikt (NY)`\n\nrutedata$Vedpl.dekn &lt;- beregn.dekning(rutedata,artsdata,\"Vedplante\")\n\nlokalitetsnavn &lt;- levels(lokalitetsdata$Lokalitet)\nregionnavn &lt;- levels(factor(lokalitetsdata$Region))\nnaturtypenavn &lt;- levels(factor(lokalitetsdata$Hovednaturtype))\n\n# Horgen og M�llerenga: tellinger av skudd (vegetative og fertile) korrigeres til estimert antall individer ----\nnames(korreksjonsdata)[6:11] &lt;- c(\"x1\",\"x2\",\"x3\",\"y1\",\"y2\",\"y3\")\n#par(mfrow=c(2,2))\n#plot(korreksjonsdata$x1,korreksjonsdata$y1,main=\"sm�planter\")\nm1 &lt;- lm(y1~-1+x1,data=korreksjonsdata)\n# summary(m1)\n# abline(m1)\n# plot(korreksjonsdata$x2,korreksjonsdata$y2,main=\"vegetative\")\n m2 &lt;- lm(y2~-1+x2,data=korreksjonsdata)\n# summary(m2)\n# abline(m2)\n#plot(korreksjonsdata$x3,korreksjonsdata$y3,main=\"fertile\")\nm3 &lt;- lm(y3~-1+x3,data=korreksjonsdata)\n# summary(m3)\n# abline(m3)\n\n i &lt;- rutedata$Lokalitet%in%c(\"Horgen\",\"M�llerenga\") & rutedata$�r%in%c(2019,2020)\n newdat &lt;- rutedata[i,c(\"Veg.planter\",\"Fert.planter\")]\n names(newdat) &lt;- c(\"x2\",\"x3\")\n y2 &lt;- round(predict(m2,newdat))\n y3 &lt;- round(predict(m3,newdat))\n y4 &lt;- rutedata[i,\"Sm�planter\"]+y2+y3\n\n #par(mfrow=c(1,3))\n #plot(rutedata[i,\"Veg.planter\"],y2)\n #plot(rutedata[i,\"Fert.planter\"],y3)\n #plot(rutedata[i,\"Ant.DR\"],y4)\n\n rutedata[i,\"Veg.planter\"] &lt;- y2\n rutedata[i,\"Fert.planter\"] &lt;- y3\n rutedata[i,\"Ant.DR\"] &lt;- y4\n\n# Populasjonsst�rrelser ----\n\n# Sjekk om forekomst varierer med avstand fra midtpunkt\n# par(mfrow=c(1,1))\n# j &lt;- rutedata$Lokalitet!=\"Ekebergskr�ningen\"\n# plot(rutedata$Avst[j],rutedata$Ant.DR[j]&gt;0,main=\"Alle lokaliteter\")\n# par(mfrow=c(5,5))\n# for(i in 1:length(lokalitetsnavn))\n# {\n#  j &lt;- rutedata$Lokalitet==lokalitetsnavn[i]\n#  plot(rutedata$Avst[j],rutedata$Ant.DR[j]&gt;0,main=lokalitetsnavn[i])\n# }\n# \n# # Sjekk om tetthet varierer med avstand fra midtpunkt\n# par(mfrow=c(1,1))\n# j &lt;- rutedata$Ant.DR&gt;0 & rutedata$Lokalitet!=\"Ekebergskr�ningen\"\n# plot(rutedata$Avst[j],rutedata$Ant.DR[j],main=\"Alle lokaliteter\")\n# par(mfrow=c(5,5))\n# for(i in 1:length(lokalitetsnavn))\n# {\n#   j &lt;- rutedata$Lokalitet==lokalitetsnavn[i] & rutedata$Ant.DR&gt;0\n#   plot(rutedata$Avst[j],rutedata$Ant.DR[j],main=lokalitetsnavn[i])\n# }\n\n\n# For hver populasjon (fordi de har s�regenheter i design, og det er �nskelig � presentere resultater for enkelt-populasjoner p� nett)\n# Ogs� for hvert �r (Hensiktsmessig hvis f.eks. design endrer seg...\n\n## lokalestimater ----\nlokalitetsestimater &lt;- list()\nfor(i in 1:length(lokalitetsnavn))\n{\n  tryCatch({\n    print(lokalitetsnavn[i])\n    popstr &lt;- beregn.popstruktur(lokalitetsnavn[i],lokalitetsdata,transektdata,rutedata,quantiles=c(0.25,0.75))\n    lokalitetsestimater[[i]] &lt;- popstr\n    \n  }, error=function(e){cat(\"ERROR :\",conditionMessage(e), \"\\n\")})\n  }\nnames(lokalitetsestimater) &lt;- lokalitetsnavn\n\n#save the Lokalitetsestimater \n\nsaveRDS(lokalitetsestimater,\"data/derived_data/lokalitetsestimater.RDS\" )\n\n### Figurer ----\n\nif(!dir.exists(\"Figurer\")) dir.create(\"Figurer\")\n\n# \"R�\" figurer av alle lokaliteter med populasjonsestimater m/CI over tid for fertile, vegetative, sm� og totalt\n#par(mfrow=c(5,5))\npdf(paste(\"Figurer/\",\"Alle lokaliteter\",\".pdf\",sep=\"\"))\nfor(i in 1:length(lokalitetsestimater))\n{\n  tryCatch({\n  popstr &lt;- lokalitetsestimater[[i]]\n  plot.popstruktur(popstr)\n  \n}, error=function(e){cat(\"ERROR :\",conditionMessage(e), \"\\n\")})\n  \n}\ndev.off()\n\nfor(i in 1:length(lokalitetsestimater))\n{\n  tryCatch({\n  #pdf(paste(\"Figurer/\",lokalitetsnavn[i],\".pdf\",sep=\"\"))\n  #png(paste(\"Figurer/\",lokalitetsnavn[i],\".png\",sep=\"\"))\n  jpeg(paste(\"Figurer/\",lokalitetsnavn[i],\".jpg\",sep=\"\"))\n  popstr &lt;- lokalitetsestimater[[i]]\n  plot.popstruktur(popstr)\n  }, error=function(e){cat(\"ERROR:\", conditionMessage(e), \"\\n\")})\n\n    dev.off()\n}\n\n\n# Populasjonstrender per gruppe, totalt, fertile, vegetative og sm�\n\nlokfarge &lt;- rainbow(length(lokalitetsnavn)); names(lokfarge) &lt;- lokalitetsnavn\nregsymbol &lt;- c(1,2,3,4,5,6); names(regsymbol) &lt;- regionnavn\nnatlinje &lt;- c(1,2); names(natlinje) &lt;- naturtypenavn\n\nthisyear=lubridate::year(Sys.time())\n\ntidsrom=c(2016.5, thisyear)\n\nif(!dir.exists(\"Figurer/Regioner\")) dir.create(\"Figurer/Regioner\")\n# Regioner\npdf(paste(\"Figurer/Regioner/\",\"Alle regioner\",\".pdf\",sep=\"\"))\nplot.gruppetrender(lokalitetsdata,gruppevariabel=\"Region\",lokalitetsestimater,reverser=T,lokalitetsnavn,lokfarge,regsymbol,natlinje)\npar(mfrow=c(1,3))\nplot(0,0,type=\"n\",axes=F,xlab=\"\",ylab=\"\"); legend(\"topleft\",lty=1,col=lokfarge,legend=lokalitetsnavn,bty=\"n\")\ndev.off()\n\n\n\nif(!dir.exists(\"Figurer/Naturtyper\")) dir.create(\"Figurer/Naturtyper\")\n# Naturtyper\npdf(paste(\"Figurer/Naturtyper/\",\"Alle hovedtyper\",\".pdf\",sep=\"\"))\nplot.gruppetrender(lokalitetsdata,gruppevariabel=\"Hovednaturtype\",lokalitetsestimater,reverser=T,lokalitetsnavn,lokfarge,regsymbol,natlinje)\npar(mfrow=c(1,3))\nplot(0,0,type=\"n\",axes=F,xlab=\"\",ylab=\"\"); legend(\"topleft\",lty=1,col=lokfarge,legend=lokalitetsnavn,bty=\"n\")\ndev.off()\n\nif(!dir.exists(\"Figurer/Skj�tsel\")) dir.create(\"Figurer/Skj�tsel\")\npdf(paste(\"Figurer/Skj�tsel/\",\"Hovedskj�tsel\",\".pdf\",sep=\"\"))\nplot.gruppetrender(lokalitetsdata,gruppevariabel=\"Hovedskj�tsel\",lokalitetsestimater,reverser=T,lokalitetsnavn,lokfarge,regsymbol,natlinje)\npar(mfrow=c(1,3))\nplot(0,0,type=\"n\",axes=F,xlab=\"\",ylab=\"\"); legend(\"topleft\",lty=1,col=lokfarge,legend=lokalitetsnavn,bty=\"n\")\ndev.off()\n\n## GGplot versions of figures\nif(!dir.exists(\"Figurer/ggplots\")) dir.create(\"Figurer/ggplots\")\nfor(i in 1:length(lokalitetsestimater)){\n  tryCatch({\n    \n    \n    \n    popstr &lt;- list(lokalitet=lokalitetsestimater[i][[1]]$lokalitet,year=lokalitetsestimater[i][[1]]$year,nFert=lokalitetsestimater[i][[1]]$nFert,\n                   nVeg=lokalitetsestimater[i][[1]]$nVeg,nSma=lokalitetsestimater[i][[1]]$nSma,nTot=lokalitetsestimater[i][[1]]$nTot,Fert.CI=lokalitetsestimater[i][[1]]$Fert.CI,\n                   Veg.CI=lokalitetsestimater[i][[1]]$Veg.CI,Sma.CI=lokalitetsestimater[i][[1]]$Sma.CI,Tot.CI=lokalitetsestimater[i][[1]]$Tot.CI)\n    \n    P=ggplot.popstruktur(popstr)  \n    \n  })\n  \n}\n\n\n\n# # Populasjonsestimater 2017-2020\n# utvalgte.lok &lt;- lokalitetsdata$Lokalitet[lokalitetsdata$�r==2017]\n# for(i in 1:length(utvalgte.lok))\n# {\n#   lok &lt;- utvalgte.lok[i]\n#   print(lokalitetsestimater[lok])\n# }\n\n# Forekomst frav�r?\n\n# Vekstrater-----\n\n\npopvekstdata &lt;- beregn.vekstrate(rutedata,\"Ant.DR\",\"RuteID\")\npopvekstdata$logR &lt;- log(popvekstdata$vekstrate)\npopvekstdata$logR[popvekstdata$logR%in%c(-Inf,Inf)] &lt;- NA\n#summary(popvekstdata$logR)\ni &lt;- match(popvekstdata$Lokalitet,lokalitetsdata$Lokalitet)\npopvekstdata$Region &lt;- lokalitetsdata$Region[i]\npopvekstdata$Hovednaturtype &lt;- lokalitetsdata$Hovednaturtype[i]\npopvekstdata$Skj�tsel_bin�r &lt;- lokalitetsdata$Skj�tsel_bin�r[i]\npopvekstdata &lt;- popvekstdata[!is.na(popvekstdata$Veg.h�yde),]\n\n\n## save popvekstdata\n saveRDS(popvekstdata, \"data/derived_data/popvekstdata.RDS\")\n\n# par(mfrow=c(1,1))\n# plot(popvekstdata[,c(\"vekstrate\",\"logR\",\"Ant.DR\",\"Bunnsjikt\",\"Feltsjikt\",\"Busksjikt\",\"Tresjikt\",\"Veg.h�yde\",\"Vedpl.dekn\",\"Region\",\"Hovednaturtype\")]) # ,\"Sm�planter\",\"Veg.planter\",\"Fert.planter\"\n# plot(popvekstdata[popvekstdata$�r==2017,c(\"vekstrate\",\"logR\",\"Veg.h�yde\",\"Vedpl.dekn\")])\n# plot(popvekstdata[popvekstdata$�r==2018,c(\"vekstrate\",\"logR\",\"Veg.h�yde\",\"Vedpl.dekn\")])\n# plot(popvekstdata[popvekstdata$�r==2019,c(\"vekstrate\",\"logR\",\"Veg.h�yde\",\"Vedpl.dekn\")])\n# plot(popvekstdata[popvekstdata$�r==2020,c(\"vekstrate\",\"logR\",\"Veg.h�yde\",\"Vedpl.dekn\")])\n# plot(popvekstdata[popvekstdata$�r==2021,c(\"vekstrate\",\"logR\",\"Veg.h�yde\",\"Vedpl.dekn\")])\n# plot(popvekstdata[popvekstdata$�r==2022,c(\"vekstrate\",\"logR\",\"Veg.h�yde\",\"Vedpl.dekn\")])\n\n\n\n# library(gamm4)\n# \n# popvekstdata$logVH &lt;- log(popvekstdata$Veg.h�yde)\n# popvekstdata$Hovednaturtype &lt;- factor(popvekstdata$Hovednaturtype)\n# popvekstdata$Year &lt;- factor(popvekstdata$�r)\n# \n# m1.gam &lt;- gamm4(logR~Hovednaturtype+s(Veg.h�yde,by=Hovednaturtype),random=~(1|Region)+(1|Lokalitet)+(1|RuteID)+(1|Year),data=popvekstdata)\n# summary(m1.gam$gam)\n# ranef(m1.gam$mer)\n# \n# m1.gam.b &lt;- gamm4(logR~Hovednaturtype+s(Veg.h�yde,by=Hovednaturtype)+s(Vedpl.dekn),random=~(1|Region)+(1|Lokalitet)+(1|RuteID)+(1|Year),data=popvekstdata)\n# summary(m1.gam.b$gam)\n# \n# m2.gam &lt;- gamm4(logR~Hovednaturtype+s(logVH,by=Hovednaturtype),random=~(1|Region)+(1|Lokalitet)+(1|RuteID)+(1|Year),data=popvekstdata)\n# summary(m2.gam$gam)\n# \n# \n# yr &lt;- seq(from=min(popvekstdata$�r), to=max(popvekstdata$�r), by=1)\n# modlist &lt;- vector(\"list\",length(yr)); names(modlist) &lt;- yr\n# for(i in 1:length(yr))\n# {\n#   y &lt;- popvekstdata$Year==yr[i] # Bare en Region (Oslo) i 2017, s� ingen random effect for region\n#   if(yr[i]==2017)\n#   {\n#     m1 &lt;- gamm4(logR~Hovednaturtype+s(Veg.h�yde,by=Hovednaturtype),random=~(1|Lokalitet),data=popvekstdata[y,])\n#     m2 &lt;- gamm4(logR~Hovednaturtype+s(logVH,by=Hovednaturtype),random=~(1|Lokalitet),data=popvekstdata[y,])\n#   }\n#   else\n#   {\n#     m1 &lt;- gamm4(logR~Hovednaturtype+s(Veg.h�yde,by=Hovednaturtype),random=~(1|Region)+(1|Lokalitet),data=popvekstdata[y,])\n#     m2 &lt;- gamm4(logR~Hovednaturtype+s(logVH,by=Hovednaturtype),random=~(1|Region)+(1|Lokalitet),data=popvekstdata[y,])\n#   }\n#   modlist[[i]] &lt;- list(m1.gam=m1,m2.gam=m2)\n# }\n# \n# pdf(paste(\"Figurer/Vekstrater/\",\"Alle plot\",\".pdf\",sep=\"\"))\n# par(mfrow=c(2,2),mar=c(4,4,2,0.1))\n# xlim &lt;- c(0,max(popvekstdata$Veg.h�yde[!is.na(popvekstdata$logR)],na.rm=T))\n# ylim &lt;- range(popvekstdata$logR,na.rm=T)\n# xlab &lt;- c(\"\",\"Vegetasjonsh�yde (cm)\",\"Vegetasjonsh�yde (cm)\")\n# ylab &lt;- c(\"\",\"log R\",\"\")\n# main &lt;- c(\"2017-2018\",\"2018-2019\",\"2019-2020\")\n# \n# i &lt;- as.numeric(popvekstdata$Hovednaturtype==\"T2\")+1\n# plot(popvekstdata$Veg.h�yde,popvekstdata$logR,pch=21,cex=0.8,bg=c(\"blue\",\"red\")[i],col=c(\"blue\",\"red\")[i],xlab=\"\",ylab=\"log R\",main=\"Alle �r\",xlim=xlim,ylim=ylim)\n# lines(popvekstdata$Veg.h�yde,predict(m1.gam$gam,newdata=data.frame(Veg.h�yde=popvekstdata$Veg.h�yde,Hovednaturtype=\"T32\",Year=\"2017\",Lokalitet=popvekstdata$Lokalitet[1],RuteID=popvekstdata$RuteID[2]),level=0),col=\"blue\",lwd=2)\n# lines(popvekstdata$Veg.h�yde,predict(m1.gam$gam,newdata=data.frame(Veg.h�yde=popvekstdata$Veg.h�yde,Hovednaturtype=\"T2\",Year=\"2017\",Lokalitet=popvekstdata$Lokalitet[1],RuteID=popvekstdata$RuteID[2]),level=0),col=\"red\",lwd=2)\n# abline(h=0,lty=3)\n# legend(\"bottomright\",c(\"T32 Seminaturlig eng\",\"T2 �pen grunnlendt mark\"),lty=c(1,1),col=c(\"blue\",\"red\"),lwd=2,bty=\"n\")\n# \n# for(i in 1:length(yr))\n# {\n#   y &lt;- popvekstdata$Year==yr[i]\n#   j &lt;- as.numeric(popvekstdata$Hovednaturtype[y]==\"T2\")+1\n#   plot(popvekstdata$Veg.h�yde[y],popvekstdata$logR[y],pch=21,cex=0.8,bg=c(\"blue\",\"red\")[j],col=c(\"blue\",\"red\")[j],xlab=xlab[i],ylab=ylab[i],main=main[i],xlim=xlim,ylim=ylim)\n#   \n#   if(i&gt;1)\n#   {\n#     VH &lt;- popvekstdata$Veg.h�yde[y][!is.na(popvekstdata$logR[y])&popvekstdata$Hovednaturtype[y]==\"T32\"]\n#     Veg.h�yde &lt;- min(VH,na.rm=T):max(VH,na.rm=T)\n#     lines(Veg.h�yde,predict(modlist[[i]]$m1.gam$gam,newdata=data.frame(Veg.h�yde=Veg.h�yde,Hovednaturtype=\"T32\",Lokalitet=popvekstdata$Lokalitet[1]),level=0),col=\"blue\",lwd=2)\n#   }\n#   VH &lt;- popvekstdata$Veg.h�yde[y][!is.na(popvekstdata$logR[y])&popvekstdata$Hovednaturtype[y]==\"T2\"]\n#   Veg.h�yde &lt;- min(VH,na.rm=T):max(VH,na.rm=T)\n#   lines(Veg.h�yde,predict(modlist[[i]]$m1.gam$gam,newdata=data.frame(Veg.h�yde=Veg.h�yde,Hovednaturtype=\"T2\",Lokalitet=popvekstdata$Lokalitet[1]),level=0),col=\"red\",lwd=2)\n# \n#   abline(h=0,lty=3)\n#   legend(\"bottomright\",c(\"T32 Seminaturlig eng\",\"T2 �pen grunnlendt mark\"),lty=c(1,1),col=c(\"blue\",\"red\"),lwd=2,bty=\"n\")\n# }\n# dev.off()\n# \n# \n# # Moodellsammendrag, tabell av random effects\n# summary(m1.gam$gam)\n# summary(m1.gam$mer)\n# ranef(m1.gam$mer)\n# \n# coef(m1.gam$mer)\n# \n# summary(modlist[[3]]$m1.gam$gam)\n# \n# table(popvekstdata$�r, popvekstdata$Hovednaturtype, popvekstdata$logR&gt;0)"
  },
  {
    "objectID": "funksjoner.html",
    "href": "funksjoner.html",
    "title": "8  Funksjoner",
    "section": "",
    "text": "For å se koden som bruker disse funksjonene, gå til Chapter 7\n\n#' Calculate coverage\n#'\n#' @param rutedata quadrate data\n#' @param artsdata species data\n#' @param artsgruppe Species \n#'\n#' @return coverage \n#' @export\n#'\nberegn.dekning &lt;- function(rutedata,artsdata,artsgruppe){\n  dekning &lt;- rep(0,nrow(rutedata))\n  for(i in 1:nrow(rutedata))\n  {\n    utvalgte.data &lt;- artsdata[,artsgruppe]==1 & artsdata$Rute==rutedata$RuteID[i] & artsdata$�r==rutedata$�r[i]\n    if(length(utvalgte.data)&gt;0) dekning[i] &lt;- sum(artsdata$Dekning[utvalgte.data],na.rm=T)\n  }\n  return(dekning)\n}\n\n\n#' Calculate area weight\n#'\n#' @param x Quadrate data\n#' @param design Linje or Rose\n#' @param lokalitetsbredde Width of locality \n#' @param rutebredde with of quadrate (defaults to 1)\n#'\n#' @return area weighting of survey to calculate estimates\n#' @keywords internal\n#'\n\nberegn.arealvekt &lt;- function(x,design,lokalitetsbredde=NA,rutebredde=1){\n  if(design==\"Linje\")\n  {\n    return(rep(lokalitetsbredde/rutebredde,length(x)))\n  }\n  if(design==\"Rose\")\n  {\n    r1 &lt;- x             # radius for indre sirkel (rutas avstand fra startpunktet)\n    r2 &lt;- x+rutebredde  # radius for ytre sirkel\n    return( (pi*r2^2 - pi*r1^2)/8 )\n  }\n}\n\n\n\n\n#' Bootstrap population\n#'\n#' @param tetthet density \n#' @param forekomstareal Occurrence area \n#' @param nboot number of bootstrap iterations (defaults to 2000)\n#'\n#' @return bootstraped estimates of population per age stage\n#' @keywords internal\n#'\nboot.pop &lt;- function(tetthet,forekomstareal,nboot=2000){\n  tetthet &lt;- tetthet[!is.na(tetthet)]\n  if(length(tetthet)==0) {print(\"Ingen individer\"); return(rep(NA,nboot))}\n  tetthet.boot &lt;- boot(tetthet,statistic=function(x,k){mean(x[k])},R=nboot)\n  forekomstareal.boot &lt;- boot(forekomstareal,statistic=function(x,k){sum(x[k])},R=nboot)\n  tetthet.boot$t * forekomstareal.boot$t\n}\n\n#' Calculate the Occurrence area\n#'\n#' @param transektdata transect data \n#' @param utvalgt.lokalitet chosen locality \n#' @param year year\n#' @param design Linje or Rose\n#' @param lokalitetsbredde Width of locality \n#' @param rutebredde with of quadrate (defaults to 1)\n#' @param forekomst_transekt \"Dragehode\" column in data\n#' @param forekomst_avstand \"Forekomst dragehode (m)\" column in data\n#'\n#' @keywords internal\nberegn.forekomstareal &lt;- function(transektdata,utvalgt.lokalitet,year,design,lokalitetsbredde,rutebredde=1,\n                                  forekomst_transekt=\"Dragehode\",forekomst_avstand=\"Forekomst dragehode (m)\"){\n  x &lt;- list()\n  for(i in 1:length(year))\n  {\n    transekter &lt;- transektdata[transektdata$Lokalitet==utvalgt.lokalitet & transektdata$�r==year[i],]\n    \n    if(all(is.na(transekter[,forekomst_transekt])))\n    {\n    \n      next\n    }\n    if(all(transekter[,forekomst_transekt]==0))\n    {\n      next\n    }\n    forekomstruter &lt;- as.numeric(unlist(sapply(transekter[,forekomst_avstand],strsplit,split=',')))\n    forekomstruter &lt;- forekomstruter[!is.na(forekomstruter)]\n    forekomstareal &lt;- beregn.arealvekt(forekomstruter,design[i],lokalitetsbredde[i],rutebredde=rutebredde)\n    x[[i]] &lt;- forekomstareal\n  }\n  mangler &lt;- unlist(lapply(x,is.null))\n  if(any(mangler))\n  {\n    erstattes &lt;- which(mangler)\n    registrert &lt;- which(!mangler)\n    #print(erstattes)\n    #print(registrert)\n    for(i in erstattes)\n    {\n      delta &lt;- abs((registrert+0.5) - i)\n      #print(delta)\n      j &lt;- registrert[delta==min(delta)]\n      #print(j)\n      x[[i]] &lt;- x[[j]]\n    }\n  }\n  return(x)\n}\n\n\n#' Calculate population structure\n#'\n#' @param utvalgt.lokalitet chosen locality\n#' @param lokalitetsdata data for that locality\n#' @param transektdata transect data \n#' @param rutedata quadrate data\n#' @param rutebredde quadrate width (defaults to 1)\n#' @param fert Fertile plants column\n#' @param veg Vegetative plants column\n#' @param sma seedlins column\n#' @param tot total plants column\n#' @param forekomst_transekt occurrence transect data\n#' @param forekomst_avstand occurrence distance\n#' @param quantiles quantiles to be calsulated (dafaults to 0.025, 0.975)\n#'\n#' @return population structure list per location\n#' @export\n#'\n\nberegn.popstruktur &lt;- function(utvalgt.lokalitet,lokalitetsdata,transektdata,rutedata,rutebredde=1,\n                               fert=\"Fert.planter\",veg=\"Veg.planter\",sma=\"SmÃ¥planter\",tot=\"Ant.DR\",\n                               forekomst_transekt=\"Dragehode\",forekomst_avstand=\"Forekomst dragehode (m)\",\n                               quantiles=c(0.025,0.975)){\n  year &lt;- lokalitetsdata[lokalitetsdata$Lokalitet==utvalgt.lokalitet,\"�r\"]\n  design &lt;- lokalitetsdata[lokalitetsdata$Lokalitet==utvalgt.lokalitet,\"Design\"]\n  lokalitetsbredde &lt;- lokalitetsdata[lokalitetsdata$Lokalitet==utvalgt.lokalitet,\"Lokalitetsbredde\"]\n  print(paste(utvalgt.lokalitet, year, design,\"bredde:\",lokalitetsbredde))\n  nboot &lt;- 2000\n  nq &lt;- length(quantiles)\n  nyear &lt;- length(year)\n  nFert &lt;- numeric(nyear)\n  nVeg &lt;- numeric(nyear)\n  nSma &lt;- numeric(nyear)\n  nTot &lt;- numeric(nyear)\n  Fert.CI &lt;- matrix(NA,nyear,nq)\n  Veg.CI &lt;- matrix(NA,nyear,nq)\n  Sma.CI &lt;- matrix(NA,nyear,nq)\n  Tot.CI &lt;- matrix(NA,nyear,nq)\n\n  forekomstareal.liste &lt;- beregn.forekomstareal(transektdata,utvalgt.lokalitet,year,design,lokalitetsbredde,rutebredde,forekomst_transekt,forekomst_avstand)\n  #print(forekomstareal.liste)\n  \n  for(i in 1:length(year))\n  {\n    forekomstareal &lt;- forekomstareal.liste[[i]]\n    saveRDS(forekomstareal, paste0(\"data/derived_data/\", utvalgt.lokalitet,\"_forekomstareal\",\"_\",i,\".RDS\"))\n    print(year[i])\n    ruter &lt;- rutedata[rutedata$Lokalitet==utvalgt.lokalitet & rutedata$�r==year[i] & rutedata[,tot]&gt;0,]\n    saveRDS(ruter, paste0(\"data/derived_data/\", utvalgt.lokalitet,\"_ruter\",\"_\",i ,\".RDS\"))\n\n    print(\"Fertile\")\n    if(!is.na(fert)) x &lt;- boot.pop(ruter[,fert],forekomstareal,nboot)\n    else x &lt;- NA\n    #print(summary(x))\n    nFert[i] &lt;- mean(x); Fert.CI[i,] &lt;- quantile(x,quantiles,na.rm=T)\n\n    print(\"Vegetative\")\n    if(!is.na(veg)) x &lt;- boot.pop(ruter[,veg],forekomstareal,nboot)\n    else x &lt;- NA\n    #print(summary(x))\n    nVeg[i] &lt;- mean(x); Veg.CI[i,] &lt;- quantile(x,quantiles,na.rm=T)\n    \n    print(\"Småplanter\")\n    if(!is.na(sma)) x &lt;- boot.pop(ruter[,sma],forekomstareal,nboot)\n    else x &lt;- NA\n    #print(summary(x))\n    nSma[i] &lt;- mean(x); Sma.CI[i,] &lt;- quantile(x,quantiles,na.rm=T)\n\n    print(\"Totalt\")\n    if(!is.na(tot)) x &lt;- boot.pop(ruter[,tot],forekomstareal,nboot)\n    else x &lt;- NA\n    print(summary(x))\n    nTot[i] &lt;- mean(x); Tot.CI[i,] &lt;- quantile(x,quantiles,na.rm=T)\n  }\n  \n  popstr &lt;- list(lokalitet=utvalgt.lokalitet,year=year,nFert=nFert,nVeg=nVeg,nSma=nSma,nTot=nTot,Fert.CI=Fert.CI,Veg.CI=Veg.CI,Sma.CI=Sma.CI,Tot.CI=Tot.CI)\n  return(popstr)\n}\n\n\n\n#' Base plot population structure\n#'\n#' @param popstr population structure data \n#'\n#' @return Baseplots of population structure per location\n#' @export\n\nplot.popstruktur &lt;- function(popstr){\n  thisyear=lubridate::year(Sys.time())\n  tidsrom=c(2016.5, thisyear)\n  plot(popstr$year,popstr$nTot,ylim=c(0,max(popstr$Tot.CI,na.rm=T)),type=\"o\",main=popstr$lokalitet,xlab=\"Ãr\",ylab=\"Antall individer\",xlim=tidsrom)\n  polygon(c(popstr$year,rev(popstr$year)),c(popstr$Tot.CI[,1],rev(popstr$Tot.CI[,2])),col=rgb(0.5,0.5,0.5,alpha=0.2),border=NA)\n  lines(popstr$year,popstr$nFert,col=\"red\",type=\"o\"); polygon(c(popstr$year,rev(popstr$year)),c(popstr$Fert.CI[,1],rev(popstr$Fert.CI[,2])),col=rgb(1,0,0,alpha=0.2),border=NA)\n  lines(popstr$year,popstr$nVeg,col=\"green\",type=\"o\"); polygon(c(popstr$year,rev(popstr$year)),c(popstr$Veg.CI[,1],rev(popstr$Veg.CI[,2])),col=rgb(0,1,0,alpha=0.2),border=NA)\n  lines(popstr$year,popstr$nSma,col=\"blue\",,type=\"o\"); polygon(c(popstr$year,rev(popstr$year)),c(popstr$Sma.CI[,1],rev(popstr$Sma.CI[,2])),col=rgb(0,0,1,alpha=0.2),border=NA)\n  #lines(popstr$year,popstr$nSma+popstr$nVeg+popstr$nFert,lty=2,type=\"o\")\n  legend(\"topleft\",c(\"Totalt\",\"Fertile\",\"Vegetative\",\"Småplanter\"),lty=c(1,1,1,1),pch=c(1,1,1,1),col=c(\"black\",\"red\",\"green\",\"blue\"),bty=\"n\")\n}\n\n\n#' Base plot group trends\n#'\n#' @param lokalitetsdata locality data\n#' @param gruppevariabel grouping variable \n#' @param lokalitetsestimater local estimates data\n#' @param reverser Reverse the axis? default is FALSE\n#' @param lokalitetsnavn locality name\n#' @param lokfarge locality colour\n#' @param regsymbol Regional symbol\n#' @param natlinje linetype for naturtype\n#'\n#' @return baseplots of group trends\n#' @export\n#'\nplot.gruppetrender &lt;- function(lokalitetsdata,gruppevariabel,lokalitetsestimater,\n                               reverser=FALSE,lokalitetsnavn,lokfarge,regsymbol,natlinje){\n  thisyear=lubridate::year(Sys.time())\n  tidsrom=c(2016.5, thisyear)\n  \n  gruppe &lt;- unique(lokalitetsdata[,gruppevariabel])\n  if(reverser) gruppe &lt;- rev(gruppe)\n  ngrp &lt;- length(gruppe)\n  par(mfcol=c(4,ngrp),mar=c(2,4,2,0.2))\n  for(i in 1:ngrp)\n  {\n    grp &lt;- as.character(gruppe[i])\n    print(grp)\n    lok &lt;- as.character(unique(lokalitetsdata[lokalitetsdata[,gruppevariabel]==grp,\"Lokalitet\"]))\n    farge &lt;- lokfarge[lok]\n    #print(lok)\n    #print(farge\n    \n    variabler &lt;- c(\"nTot\",\"nFert\",\"nVeg\",\"nSma\")\n    if(i==1) ylab &lt;- c(\"Antall totalt\",\"Antall fertile\",\"Antall vegetative\",\"Antall smÃ¥planter\")\n    else ylab &lt;- rep(\"\",length(variabler))\n    xlab &lt;- c(rep(\"\",length(variabler)-1),\"Ãr\")\n    main &lt;- c(grp,rep(\"\",length(variabler)-1))\n    for(i in 1:length(variabler))\n    {\n      noplot &lt;- TRUE\n      for(j in 1:length(lok))\n      {\n        #print(lok[j])\n        reg &lt;- as.character(unique(lokalitetsdata[lokalitetsdata$Lokalitet==lok,\"Region\"]))\n        symbol &lt;- regsymbol[reg]\n        nat &lt;- as.character(unique(lokalitetsdata[lokalitetsdata$Lokalitet==lok,\"Hovednaturtype\"]))\n        linje &lt;- natlinje[nat]\n        #print(linje)\n        \n        popstr &lt;- lokalitetsestimater[lok[j]][[1]]\n        if(length(popstr)==1) {print(\"Ingen estimater\"); next}\n        if(noplot)\n        {\n          plot(popstr$year,popstr[variabler[i]][[1]],xlim=tidsrom,ylim=c(1,70000),type=\"o\",col=farge[j],     #pch=symbol,lty=linje,\n               main=main[i],xlab=xlab[i],ylab=ylab[i],log=\"y\")\n          noplot &lt;- FALSE\n        }\n        else lines(popstr$year,popstr[variabler[i]][[1]],type=\"o\",col=farge[j]) #,pch=symbol,lty=linje)\n      }\n    }\n  }\n}\n\n#\n\n#' Calculate growth rate\n#'\n#' @param rutedata quadrate data\n#' @param popvar population variable (Total Dragehode )\n#' @param idvar Id of the quadrate (RuteID)\n#'\n#' @return growthrate estimates\n#' @export\n\nberegn.vekstrate &lt;- function(rutedata,popvar,idvar){\n  vekstrate &lt;- rep(NA,nrow(rutedata))\n  year &lt;- sort(as.numeric(unique(rutedata$�r)))\n  nyear &lt;- length(year)\n  if(nyear&lt;2) return(NA)\n  for(i in 1:(nyear-1))\n  {\n    t1 &lt;- rutedata$�r==year[i]\n    t2 &lt;- rutedata$�r==year[i+1]\n    idmatch &lt;- match(rutedata[t1,idvar],rutedata[t2,idvar])\n    vekstrate[t1] &lt;- rutedata[t2,popvar][idmatch] / rutedata[t1,popvar] \n  }\n  rutedata$vekstrate &lt;- vekstrate\n  return(rutedata)\n}\n\n\n#' GGplot version of plot.popstruktur\n#'\n#' @param popstr population structure\n#'\n#' @return plots of population structure\n#' @export\n#'\n\nggplot.popstruktur &lt;- function(popstr){\n  require(tidyverse)\n  title=popstr$lokalitet\n  popstr=as_tibble(popstr)\n  names(popstr)&lt;-c( \"lokalitet\" ,\"year\",      \"Fertile\",     \"Vegetative\",      \"Småplanter\",      \"Totalt\",     \n                    \"Fert.CI\",   \"Veg.CI\",    \"Sma.CI\",    \"Tot.CI\" )\n  \n  \n  popstrCI=popstr %&gt;% \n    mutate(\"Fert.CI_upper\"= Fert.CI[,2]) %&gt;% \n    mutate(\"Fert.CI_lower\"= Fert.CI[,1]) %&gt;% \n    mutate(\"Tot.CI_upper\"= Tot.CI[,2]) %&gt;% \n    mutate(\"Tot.CI_lower\"= Tot.CI[,1]) %&gt;%\n    mutate(\"Veg.CI_upper\"= Veg.CI[,2]) %&gt;% \n    mutate(\"Veg.CI_lower\"= Veg.CI[,1]) %&gt;%\n    mutate(\"Sma.CI_upper\"= Sma.CI[,2]) %&gt;% \n    mutate(\"Sma.CI_lower\"= Sma.CI[,1]) %&gt;%\n    select(!lokalitet) %&gt;% \n    pivot_longer(!year, names_to = \"key\", values_to = \"value\") %&gt;% \n    filter(key%in% c(\"Fert.CI\", \"Veg.CI\",\"Sma.CI\", \"Tot.CI\")) %&gt;% \n    mutate(var=gsub(\".CI\",\"\", key))\n  \n  popstrCI=popstrCI%&gt;% \n    mutate(var=rep(c(\"Fertile\", \"Vegetative\", \"Småplanter\", \"Totalt\"),(dim(popstrCI)[1]/4))) %&gt;% \n    mutate(upper=value[,2]) %&gt;% \n    mutate(lower=value[,1]) %&gt;% \n    select(!value)\n  \n  \n  \n  popstr_plot=popstr %&gt;% \n    mutate(\"Fert.CI_upper\"= Fert.CI[,2]) %&gt;% \n    mutate(\"Fert.CI_lower\"= Fert.CI[,1]) %&gt;% \n    mutate(\"Tot.CI_upper\"= Tot.CI[,2]) %&gt;% \n    mutate(\"Tot.CI_lower\"= Tot.CI[,1]) %&gt;%\n    mutate(\"Veg.CI_upper\"= Veg.CI[,2]) %&gt;% \n    mutate(\"Veg.CI_lower\"= Veg.CI[,1]) %&gt;%\n    mutate(\"Sma.CI_upper\"= Sma.CI[,2]) %&gt;% \n    mutate(\"Sma.CI_lower\"= Sma.CI[,1]) %&gt;%\n    select(!lokalitet) %&gt;% \n    pivot_longer(!year, names_to = \"key\", values_to = \"value\") %&gt;%\n    #filter(!key%in% c(\"Fert.CI\", \"Veg.CI\",\"Sma.CI\", \"Tot.CI\")) %&gt;% \n    filter(key%in% c(\"Fertile\", \"Småplanter\", \"Totalt\", \"Vegetative\")) %&gt;% \n    mutate(upper=popstrCI$upper) %&gt;% \n    mutate(lower=popstrCI$lower)\n  \n  p=popstr_plot%&gt;% \n    ggplot(aes(year,value[,1], colour=key))+\n    geom_point(size=2)+\n    geom_ribbon(aes(ymin=lower, ymax=upper, fill=popstr_plot$key), alpha=0.2)+\n    scale_fill_manual(values = c(\"darkred\", \"darkblue\", \"darkgrey\", \"darkgreen\"), guide=\"none\")+\n    geom_line( size=1.2)+\n    scale_colour_manual(values = c(\"darkred\", \"darkblue\", \"darkgrey\", \"darkgreen\"))+\n    labs(x=\"Ãr\", y= \"Antall individer\")+\n    ggtitle(title)+\n    theme_classic()\n  \n  ggsave(\n    paste0(here::here(),\"/Figurer/ggplots/\" ,title, \".png\"))              \n  \n}"
  }
]